(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{114:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return c})),n.d(t,"metadata",(function(){return i})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return s}));var a=n(1),r=n(6),o=(n(0),n(123)),c={id:"keycloak-authz",title:"Out of the box Keycloak based authentication",sidebar_label:"Keycloak Auth"},i={id:"keycloak-authz",title:"Out of the box Keycloak based authentication",description:"## Authorization using Keycloak",source:"@site/../docs/integrations_graphback_keycloak.md",permalink:"/docs/keycloak-authz",editUrl:"https://github.com/aerogear/OpenVolunteerPlatform/edit/master/website/../docs/integrations_graphback_keycloak.md",sidebar_label:"Keycloak Auth",sidebar:"docs",previous:{title:"Data Model",permalink:"/docs/datamodel"},next:{title:"AMQ Live updates",permalink:"/docs/liveupdates"}},l=[{value:"Authorization using Keycloak",id:"authorization-using-keycloak",children:[]},{value:"Getting Started",id:"getting-started",children:[]},{value:"Example with Graphback Runtime",id:"example-with-graphback-runtime",children:[]}],p={rightToc:l};function s(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"authorization-using-keycloak"},"Authorization using Keycloak"),Object(o.b)("p",null,"Graphback Keycloak Authz enables ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.keycloak.org/"}),"Keycloak")," integration in ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://graphback.dev"}),"Graphback")," based applications. This enables you to declaratively add authorization capabilities like role based access on top of the CRUD model that is used within Graphback."),Object(o.b)("p",null,"This package is designed to work with ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.npmjs.com/package/keycloak-connect"}),Object(o.b)("inlineCode",{parentName:"a"},"keycloak-connect"))," and ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.npmjs.com/package/keycloak-connect-graphql"}),Object(o.b)("inlineCode",{parentName:"a"},"keycloak-connect-graphql")),". ",Object(o.b)("inlineCode",{parentName:"p"},"keycloak-connect")," is the official Keycloak middleware for Express applications. ",Object(o.b)("inlineCode",{parentName:"p"},"keycloak-connect-graphql")," provides deeper Keycloak integration into GraphQL servers."),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"NOTE: This package is an early alpha and not officially supported by Graphback")),Object(o.b)("h2",{id:"getting-started"},"Getting Started"),Object(o.b)("p",null,"This module requires you to install the following dependencies into your application."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"npm install keycloak-connect\nnpm install keycloak-connect-graphql\n")),Object(o.b)("p",null,"Then follow the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/aerogear/keycloak-connect-graphql#getting-started"}),"Getting started instructions for ",Object(o.b)("inlineCode",{parentName:"a"},"keycloak-connect-graphql"))),Object(o.b)("p",null,"Once the getting started instructions are covered, you must create a configuration that defines the authorization rules for each model within your Graphback application."),Object(o.b)("p",null,"Here is an example configuration."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"const authConfig = {\n  Task: {\n    create: {},\n    read: {},\n    update: { roles: ['admin'] },\n    delete: { roles: ['admin'] },\n  },\n  Report: {\n    create: { roles: ['admin'] },\n    read: {},\n    update: { roles: ['admin'] },\n    delete: { roles: ['admin'] },\n  },\n};\n")),Object(o.b)("p",null,"With this configuration the following rules are in place."),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"All users can create and read ",Object(o.b)("inlineCode",{parentName:"li"},"Task")," types but only admins can update and delete them."),Object(o.b)("li",{parentName:"ul"},"Admin users can create, update and delete ",Object(o.b)("inlineCode",{parentName:"li"},"Report")," types, and all users can read them.")),Object(o.b)("h2",{id:"example-with-graphback-runtime"},"Example with Graphback Runtime"),Object(o.b)("p",null,"During server initialization, use the ",Object(o.b)("inlineCode",{parentName:"p"},"createKeycloakCRUDService")," function to initialize the KeycloakCrudService instances for each model."),Object(o.b)("p",null,"The following example shows just the necessary parts to set up the runtime services in Graphback."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"import { ApolloServer } from 'apollo-server-express'\nimport { createKeycloakCRUDService } from '@graphback/keycloak-authz'\nimport { KnexDbDataProvider } from '@graphback/runtime-knex'\nimport { PubSub } from 'graphql-subscriptions'\nimport * as Knex from 'knex'\nimport { buildGraphbackAPI, createCRUDService } from 'graphback'\n\n// the application model\nconst model = `\n\"\"\"\n@model\n\"\"\"\ntype Task {\n  id: ID!\n  title: String!\n  description: String!\n}`\n\n// the auth rules for the application\nconst authConfig = {\n  Task: {\n    create: {},\n    read: {},\n    update: { roles: [\"admin\"] },\n    delete: { roles: [\"admin\"] }\n  }\n}\n\n// set up the Knex database client\nconst db = Knex({...})\n\n// standard Graphback runtime setup\nconst pubSub = new PubSub()\n\nconst keycloakService = createKeycloakCRUDService(authConfig, createCRUDService({\n  pubSub: new PubSub()\n}));\nconst { typeDefs, resolvers, contextCreator } = buildGraphbackAPI(modelDefs, {\n  serviceCreator: keycloakService,\n  dataProviderCreator: createKnexDbProvider(db)\n});\n\nconst server = new ApolloServer({\n  typeDefs,\n  resolvers,\n  context: (context) => {\n    return {\n      ...contextCreator(context),\n      kauth: new KeycloakContext({ req: context.req })\n    }\n  }\n})\n")),Object(o.b)("p",null,"The above example shows runtime set up using the KnexDbDataProvider, but other data providers such as the ",Object(o.b)("inlineCode",{parentName:"p"},"MongoDBDataProvider")," can also be passed."))}s.isMDXComponent=!0},123:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=r.a.createContext({}),s=function(e){var t=r.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i({},t,{},e)),n},u=function(e){var t=s(e.components);return r.a.createElement(p.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=s(n),d=a,h=u["".concat(c,".").concat(d)]||u[d]||b[d]||o;return n?r.a.createElement(h,i({ref:t},p,{components:n})):r.a.createElement(h,i({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,c=new Array(o);c[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:a,c[1]=i;for(var p=2;p<o;p++)c[p]=n[p];return r.a.createElement.apply(null,c)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);